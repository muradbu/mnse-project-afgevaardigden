---
- name: Configure Aggregate Routers
  hosts: aggregate_routers
  gather_facts: no
  tasks:
    - name: "Configure BGP Peer Sub-interfaces"
      cisco.ios.ios_config:
        lines:
          - "encapsulation dot1Q {{ item.encapsulation }}"
          - "ip address {{ item.ip }} {{ item.mask }}"
        parents: "interface {{ item.name }}"
      loop: "{{ interfaces }}"
      when:
        - interfaces is defined
        - "'Tunnel' not in item.name"

    - name: "Configure BGP Peer Tunnel Interfaces"
      cisco.ios.ios_config:
        lines:
          - "ip address {{ item.ip }} {{ item.mask }}"
          - "tunnel mode gre ip"
        parents: "interface {{ item.name }}"
      loop: "{{ interfaces }}"
      when:
        - interfaces is defined
        - "'Tunnel' in item.name"

    - name: "Configure BGP"
      cisco.ios.ios_bgp_global:
        config: "{{ bgp_config }}"
        state: merged

- name: Configure Aggregate Noord/Zuid
  hosts: aggregate_noord, aggregate_zuid
  gather_facts: no
  tasks:
    - name: "Configure OSPF Process"
      cisco.ios.ios_ospfv2:
        config:
          processes:
            - process_id: "{{ ospf_process_id }}"
              router_id: "{{ bgp_config.bgp.router_id.address }}"
        state: merged

    - name: "Configure OSPF Redistribution"
      cisco.ios.ios_config:
        lines:
          - "redistribute bgp {{ bgp_config.as_number }} subnets"
        parents:
          - "router ospf {{ ospf_process_id }}"

    - name: "Configure Client Router Sub-interfaces"
      cisco.ios.ios_config:
        lines:
          - "encapsulation dot1Q {{ item.vlan }}"
          - "ip address {{ item.p2p_subnet | ansible.utils.ipmath(1) }} 255.255.255.252"
          - "ip ospf {{ ospf_process_id }} area 0"
        parents: "interface GigabitEthernet0/0/0.{{ item.vlan }}"
      loop: "{{ client_routers }}"

    - name: "Configure BGP to redistribute OSPF"
      cisco.ios.ios_config:
        lines:
          - "redistribute ospf {{ ospf_process_id }}"
        parents:
          - "router bgp {{ bgp_config.as_number }}"
      when: bgp_config is defined

- name: Configure Aggregate DC
  hosts: aggregate_dc
  gather_facts: no
  tasks:
    - name: "Configure Server Router Sub-interfaces"
      cisco.ios.ios_config:
        lines:
          - "encapsulation dot1Q {{ item.vlan }}"
          - "ip address {{ item.p2p_subnet }} 255.255.255.252"
        parents: "interface GigabitEthernet0/0/0.{{ item.vlan }}"
      loop: "{{ server_routers }}"
